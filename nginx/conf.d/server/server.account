listen 443 ssl http2;

include /etc/nginx/conf.d/include/ssl-settings;
include /etc/nginx/conf.d/include/init-optional-variables;

location / {
    rewrite_by_lua_block {
        local skynet_account = require("skynet.account")

        if skynet_account.accounts_disabled() and skynet_account.should_redirect_for_disabled_accounts() then
            local utils = require("utils")
            return ngx.redirect(utils.getenv("DISABLED_ACCOUNTS_REDIRECT_URL"))
        end
    }

    proxy_pass http://dashboard:9000;
}

location /health {
    proxy_pass http://accounts:3000;
}

location /stripe/webhook {
    proxy_pass http://accounts:3000;
}

location /api {
    rewrite /api/(.*) /$1 break;
    proxy_pass http://accounts:3000;
}

location /api/register {
    include /etc/nginx/conf.d/include/cors;

    rewrite /api/(.*) /$1 break;
    proxy_pass http://accounts:3000;
}

location /api/user/pubkey/register {
    include /etc/nginx/conf.d/include/cors;

    rewrite /api/(.*) /$1 break;
    proxy_pass http://accounts:3000;
}

location /api/login {
    include /etc/nginx/conf.d/include/cors;

    rewrite /api/(.*) /$1 break;
    proxy_pass http://accounts:3000;
}

location /api/logout {
    include /etc/nginx/conf.d/include/cors;

    rewrite /api/(.*) /$1 break;
    proxy_pass http://accounts:3000;
}
